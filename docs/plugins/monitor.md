# Monitor 监控中心插件文档

## 概述

Monitor 插件提供全面的域名监控、告警管理和性能监测功能，帮助运维团队及时发现和处理问题。

## 功能特性

### 域名监控
- SSL/TLS 证书监控
- 证书到期提醒
- 证书信息查询
- 多域名批量管理
- 证书链验证

### 告警管理
- 告警规则配置
- 多渠道通知（邮件、短信、钉钉、企业微信）
- 告警策略模板

### 告警接收器
- 邮件通知配置
- 短信接收人管理
- 钉钉群组绑定
- 企业微信应用配置
- Webhook 回调配置

### 告警日志
- 完整的告警发送记录
- 告警状态跟踪
- 告警重复发送控制
- 告警历史查询
- 告警统计分析

## 安装与启用

### 通过管理界面安装

1. 登录 OpsHub 系统
2. 进入「系统管理」-「插件管理」
3. 在可用插件列表中找到「Monitor」
4. 点击「安装」按钮
5. 刷新页面查看效果



## 使用指南

### 域名监控

#### 添加要监控的域名

1. 进入「监控中心」-「域名监控」
2. 点击「添加域名」按钮
3. 输入要监控的域名：
   - 域名/URL
   - 备注描述
   - 监控周期（建议每7天检查一次）
4. 点击「保存」完成添加
5. 系统自动获取证书信息

#### 查看证书详情

点击域名列表中的某个域名，可以查看以下信息：

- **颁发者**: 证书颁发机构
- **主体**: 证书绑定的域名
- **有效期**: 证书生效与过期日期
- **算法**: 使用的加密算法
- **序列号**: 证书序列号
- **指纹**: 证书 SHA256 指纹

#### 证书到期提醒

1. 系统会根据证书过期时间自动生成告警
2. 在证书过期前 7 天、3 天、1 天分别提醒
3. 可以通过修改告警规则调整提醒时间
4. 提醒会通过配置的通知渠道发送

### 告警管理

#### 创建告警规则

1. 进入「监控中心」-「告警管理」-「告警规则」
2. 点击「新建规则」按钮
3. 填写规则信息：
   - 规则名称
   - 规则描述
   - 告警级别（紧急、高、中、低）
   - 告警条件（支持表达式）
4. 选择通知接收器
5. 配置防抖（避免频繁告警）
6. 点击「保存」

#### 告警条件示例

```
# 监控 URL 响应时间（毫秒）
response_time > 5000

# 监控错误率
error_rate > 0.05

# 监控证书有效期（天数）
cert_days_left < 7
```

#### 告警分级说明

| 级别 | 含义 | 处理时间 |
|-----|------|--------|
| 紧急 | 服务已中断或即将中断 | 立即处理 |
| 高 | 服务性能严重下降 | 30分钟内 |
| 中 | 服务性能略有下降 | 2小时内 |
| 低 | 一般性问题或提醒 | 当天内 |

### 告警接收器配置

#### 邮件通知

1. 进入「监控中心」-「告警管理」-「告警接收器」
2. 点击「新建接收器」，选择「邮件」
3. 配置邮件参数：
   ```
   SMTP 服务器: smtp.gmail.com
   SMTP 端口: 587
   发送人邮箱: your-email@gmail.com
   邮箱密码: your-app-password
   ```
4. 添加收件人邮箱
5. 点击「测试」验证配置
6. 点击「保存」

#### 短信通知

1. 选择「短信」接收器类型
2. 配置短信网关：
   - 短信服务商（阿里云、腾讯云等）
   - API Key 和 Secret
   - 签名和模板 ID
3. 添加接收人电话号码
4. 测试短信发送
5. 保存配置

#### 钉钉通知

1. 选择「钉钉」接收器类型
2. 创建钉钉群组并获取 Webhook 地址
3. 配置参数：
   ```
   Webhook URL: https://oapi.dingtalk.com/robot/send?access_token=xxx
   ```
4. 配置 @ 提醒人员（可选）
5. 测试消息发送
6. 保存配置

#### 企业微信通知

1. 选择「企业微信」接收器类型
2. 创建企业微信应用
3. 配置参数：
   ```
   企业 ID: xxxxxxxxxxxxxxxx
   应用 ID: 1000001
   应用密钥: xxx...xxx
   接收部门 ID: 或接收用户 ID
   ```
4. 测试消息发送
5. 保存配置

#### Webhook 回调

1. 选择「Webhook」接收器类型
2. 配置回调地址：
   ```
   POST URL: https://your-server.com/webhook/alert
   ```
3. 配置请求头（可选）
4. 选择回调事件类型
5. 测试回调
6. 保存配置

回调 JSON 格式：
```json
{
  "alert_id": "123456",
  "alert_name": "证书即将过期",
  "alert_level": "high",
  "domain": "example.com",
  "message": "example.com 证书将在3天后过期",
  "timestamp": "2024-01-26T10:30:00Z",
  "status": "triggered"
}
```

### 告警日志

1. 进入「监控中心」-「告警管理」-「告警日志」
2. 查看所有告警发送记录：
   - 告警时间
   - 告警级别
   - 告警名称
   - 发送状态
   - 接收器
3. 支持按条件筛选和导出

## 监控指标

### 域名监控指标

| 指标 | 说明 | 单位 |
|-----|------|------|
| 证书有效期 | 从现在到证书过期的天数 | 天 |
| 响应时间 | HTTP 请求响应时间 | 毫秒 |
| 状态码 | HTTP 响应状态码 | - |
| SSL 版本 | 使用的 SSL/TLS 版本 | - |
| 证书链深度 | 证书链中的证书数量 | - |

### 系统监控指标

| 指标 | 说明 | 单位 |
|-----|------|------|
| CPU 使用率 | 系统 CPU 占用百分比 | % |
| 内存使用率 | 系统内存占用百分比 | % |
| 磁盘使用率 | 磁盘空间占用百分比 | % |
| 网络流量 | 网络入出流量 | Mbps |
| 系统负载 | 1分钟/5分钟/15分钟平均负载 | - |

## 性能优化

### 告警防抖

防止同一告警重复发送过于频繁：

```yaml
# 告警规则配置
alert_rule:
  name: "证书过期提醒"
  enabled: true
  # 防抖时间: 告警发送后，相同告警在30分钟内不再发送
  silence_duration: 30m
```

### 告警聚合

将相关告警合并为一条通知：

```yaml
# 聚合配置
aggregation:
  enabled: true
  window: 5m  # 5分钟内的告警聚合为一条
  threshold: 3  # 达到3条告警才发送聚合通知
```

## 最佳实践

### 监控策略

1. **分级监控**: 根据业务重要性设置不同的监控级别
2. **合理告警**: 避免设置过于敏感的告警规则，防止告警疲劳
3. **防抖配置**: 为重复性告警设置合理的防抖时间
4. **多渠道通知**: 对紧急告警配置多个通知渠道

### 证书管理建议

1. **定期检查**: 每月检查一次即将过期的证书
2. **提前更新**: 在证书过期前 30 天开始更新
3. **备份保存**: 保存重要证书的备份副本
4. **错误处理**: 配置告警接收器确保接收到通知

### 告警规则建议

1. **明确告警**: 告警信息应该清晰说明问题和建议的解决方案
2. **关联告警**: 关联相关的告警规则，避免重复通知
3. **定期审查**: 定期审查告警规则的有效性和准确性
4. **文档说明**: 为复杂的告警规则添加说明文档

## 常见问题

### Q: 为什么没有收到告警通知？
A: 检查以下几点：
1. 告警规则是否启用
2. 通知接收器配置是否正确
3. 查看告警日志检查发送状态
4. 检查邮件垃圾箱

### Q: 如何禁用某个告警？
A: 进入告警规则列表，找到对应规则，点击「禁用」按钮即可。

### Q: 证书信息更新频率是多少？
A: 默认每天更新一次。可以在规则中修改检查周期。

### Q: 支持哪些短信服务商？
A: 支持阿里云、腾讯云、华为云、JimuReport 等主流服务商。

## 更新日志

### v1.0.0 (2024-01-XX)
- 初始版本发布
- 支持域名监控功能
- 告警规则配置与管理
- 多渠道告警通知
- 告警日志记录

## 相关文档

- [SSL 证书最佳实践](https://www.ssl.com/article/ssl-tls-best-practices/)
- [告警设计原则](https://www.monitoring-strategies.com/)
- [OpsHub 主文档](../../README.md)
