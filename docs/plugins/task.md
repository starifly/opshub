# Task 任务中心插件文档

## 概述

Task 插件提供强大的任务编排与执行能力，支持脚本执行、批量操作、文件分发等功能。

## 功能特性

### 执行任务
- 脚本执行（Shell、Python、Perl 等）
- 批量主机执行
- 实时日志输出
- 执行结果统计
- 错误处理与重试

### 模板管理
- 任务模板定义
- 模板参数配置
- 模板版本控制
- 模板分类管理
- 模板复用与优化

### 文件分发
- 多文件批量分发
- 目标主机选择
- 分发路径配置
- 传输进度显示
- 文件完整性校验

### 执行历史
- 执行记录查询
- 执行日志查看
- 执行时间统计
- 执行状态跟踪
- 历史数据导出

## 安装与启用

### 通过管理界面安装

1. 登录 OpsHub 系统
2. 进入「系统管理」-「插件管理」
3. 在可用插件列表中找到「Task」
4. 点击「安装」按钮
5. 刷新页面查看效果

### 通过 API 启用

```bash
# 启用 Task 插件
curl -X POST http://localhost:9876/api/v1/plugins/task/enable \
  -H "Authorization: Bearer YOUR_JWT_TOKEN"

# 禁用 Task 插件
curl -X POST http://localhost:9876/api/v1/plugins/task/disable \
  -H "Authorization: Bearer YOUR_JWT_TOKEN"
```

## 使用指南

### 执行任务

#### 方式一：直接执行脚本

1. 进入「任务中心」-「执行任务」
2. 选择执行方式：「脚本执行」
3. 编写或选择脚本内容
4. 选择目标主机
5. 点击「执行」按钮
6. 查看实时执行日志

#### 方式二：使用任务模板

1. 进入「任务中心」-「模板管理」
2. 选择或创建任务模板
3. 设置模板参数
4. 点击「执行」按钮
5. 查看执行结果

### 创建任务模板

#### 步骤

1. 进入「任务中心」-「模板管理」
2. 点击「新建模板」按钮
3. 填写模板基本信息：
   - 模板名称
   - 模板描述
   - 脚本语言
4. 编写脚本内容
5. 定义模板参数（可选）
6. 设置超时时间
7. 点击「保存」完成创建

#### 模板参数

在脚本中使用占位符定义参数：

```bash
#!/bin/bash
# 示例：安装软件模板

# 参数: PACKAGE_NAME
apt-get update
apt-get install -y {{PACKAGE_NAME}}

# 参数: SERVICE_NAME
systemctl start {{SERVICE_NAME}}
systemctl enable {{SERVICE_NAME}}
```

执行时会提示输入 `PACKAGE_NAME` 和 `SERVICE_NAME` 的值。

### 文件分发

#### 单个文件分发

1. 进入「任务中心」-「文件分发」
2. 点击「新建分发任务」
3. 上传要分发的文件
4. 选择目标主机
5. 设置分发路径
6. 点击「开始分发」

#### 批量文件分发

1. 选择多个文件
2. 使用拖拽或点击添加
3. 配置分发参数：
   - 目标路径
   - 文件权限（755、644等）
   - 用户:用户组
4. 选择目标主机组
5. 点击「开始分发」

### 查看执行历史

1. 进入「任务中心」-「执行历史」
2. 按条件筛选：
   - 执行时间
   - 执行状态
   - 执行用户
   - 任务名称
3. 点击记录查看详细执行日志
4. 支持日志导出

## 脚本语言支持

### Shell 脚本

最常用的脚本类型，支持 Bash、Sh 等：

```bash
#!/bin/bash

# 检查服务状态
systemctl status nginx

# 重启服务
systemctl restart nginx

# 查看日志
tail -f /var/log/nginx/error.log
```

### Python 脚本

用于复杂的数据处理和系统管理：

```python
#!/usr/bin/env python3

import os
import subprocess

# 列出所有进程
output = subprocess.run(['ps', 'aux'], capture_output=True, text=True)
print(output.stdout)

# 执行系统命令
os.system('uptime')
```

### Perl 脚本

支持文本处理和系统管理：

```perl
#!/usr/bin/perl

# 读取配置文件
open(FH, '</etc/nginx/nginx.conf') or die "Cannot open file: $!";
while(<FH>) {
    print $_;
}
close(FH);
```

## 权限管理

### 基于角色的权限

配置不同角色对任务功能的访问权限：

1. 进入「权限管理」-「角色管理」
2. 编辑角色权限
3. 分配以下权限：
   - 执行任务
   - 创建模板
   - 文件分发
   - 查看历史

### 基于主机的权限

限制用户只能操作特定主机：

1. 进入「权限管理」-「主机权限」
2. 为用户或角色分配主机访问权限
3. 设置权限级别（查看、执行、管理）

## 高级功能

### 定时任务

支持使用 Cron 表达式定义定时执行：

```
# 每天凌晨2点执行备份
0 2 * * * /opt/scripts/backup.sh

# 每周一下午3点执行检查
0 15 * * 1 /opt/scripts/check.sh

# 每5分钟执行一次监控
*/5 * * * * /opt/scripts/monitor.sh
```

### 任务链

支持定义任务之间的依赖关系：

1. 创建多个基础任务
2. 进入「任务中心」-「任务链」
3. 新建任务链
4. 添加任务并设置依赖关系
5. 定义失败处理策略（继续/中止）

### 任务通知

执行完成后支持多种通知方式：

- 邮件通知
- 短信通知
- Webhook 回调
- 钉钉/企业微信通知

## 常见问题

### Q: 脚本执行超时如何处理？
A: 在模板设置中可以配置超时时间。超时后任务会自动中止，可以在参数中调整超时时间。

### Q: 如何让脚本以特定用户身份运行？
A: 在分发任务时可以指定 `user:group`，脚本将以该用户身份执行。

### Q: 文件分发失败后如何重试？
A: 系统支持自动重试，可以在任务设置中配置重试次数和重试间隔。

### Q: 如何导出执行历史记录？
A: 在执行历史页面，选择时间范围后点击「导出」按钮，支持 CSV 和 Excel 格式。

## 最佳实践

### 脚本编写建议

1. **使用 Shebang**: 始终在脚本开头指定解释器
2. **错误处理**: 使用 `set -e` 或检查返回值
3. **日志输出**: 在脚本中添加日志便于调试
4. **参数验证**: 验证输入参数的有效性
5. **超时保护**: 对长期运行的命令设置超时

### 模板管理建议

1. **命名规范**: 使用清晰的模板名称和描述
2. **版本控制**: 定期更新和测试模板
3. **参数化**: 尽可能使用参数提高模板复用性
4. **文档完善**: 为复杂模板添加使用说明

### 安全建议

1. **权限最小化**: 按需分配权限，避免过度授权
2. **审计日志**: 定期检查执行历史和操作日志
3. **敏感数据**: 避免在脚本中硬编码密码
4. **命令注入**: 对用户输入进行验证和转义

## 更新日志

### v1.0.0 (2024-01-XX)
- 初始版本发布
- 支持脚本执行与模板管理
- 文件分发功能
- 执行历史记录

## 相关文档

- [Shell 脚本教程](https://www.gnu.org/software/bash/manual/)
- [Python 文档](https://docs.python.org/)
- [OpsHub 主文档](../../README.md)
